# ç³»ç»Ÿæ¶æ„è¯¦è§£ ğŸ—ï¸

## æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ValuationReportSystem                        â”‚
â”‚                        (ä¸»æ§åˆ¶å™¨)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                               â”‚
         â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Clients    â”‚            â”‚    Agents       â”‚
â”‚  (æ¥å£å±‚)       â”‚            â”‚   (æ™ºèƒ½å±‚)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                               â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚                  â”‚      â”‚      â”‚
    â–¼         â–¼                  â–¼      â–¼      â–¼
â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”
â”‚Sonarâ”‚  â”‚Qwen â”‚          â”‚Queryâ”‚â”‚Info â”‚â”‚Deep â”‚
â”‚     â”‚  â”‚     â”‚          â”‚Plan â”‚â”‚Coll â”‚â”‚Anal â”‚
â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”˜
```

## æ•°æ®æµå›¾

```
ç”¨æˆ·è¾“å…¥
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æŸ¥è¯¢è§„åˆ’é˜¶æ®µ (QueryPlannerAgent)                      â”‚
â”‚    â€¢ è¾“å…¥: å…¬å¸åç§°                                       â”‚
â”‚    â€¢ ä½¿ç”¨: Qwen3-Max (è½»é‡çº§, ~500 tokens)               â”‚
â”‚    â€¢ è¾“å‡º: 8ä¸ªç»“æ„åŒ–æŸ¥è¯¢                                  â”‚
â”‚    â€¢ ç­–ç•¥: JSONæ ¼å¼, ä½æ¸©åº¦(0.3), ç¡®ä¿ç²¾ç¡®               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â”‚ [æŸ¥è¯¢åˆ—è¡¨]
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ä¿¡æ¯æ”¶é›†é˜¶æ®µ (InformationCollectorAgent)              â”‚
â”‚    â€¢ è¾“å…¥: 8ä¸ªæŸ¥è¯¢                                        â”‚
â”‚    â€¢ ä½¿ç”¨: Sonar API (å¹¶è¡Œæ‰§è¡Œ)                          â”‚
â”‚    â€¢ å¹¶å‘: 5ä¸ªåŒæ—¶æ‰§è¡Œ                                    â”‚
â”‚    â€¢ è¾“å‡º: æŒ‰ä¼˜å…ˆçº§åˆ†ç±»çš„å®æ—¶ä¿¡æ¯                         â”‚
â”‚    â€¢ ç­–ç•¥: asyncioå¹¶è¡Œ, æœ€å¤§åŒ–é€Ÿåº¦                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â”‚ [åˆ†ç±»ä¿¡æ¯é›†åˆ]
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æ·±åº¦åˆ†æé˜¶æ®µ (DeepAnalystAgent)                       â”‚
â”‚    â€¢ è¾“å…¥: æ ¼å¼åŒ–çš„å…¨éƒ¨ä¿¡æ¯                               â”‚
â”‚    â€¢ ä½¿ç”¨: Qwen3-Max (æ·±åº¦æ¨ç†, ~8000 tokens)            â”‚
â”‚    â€¢ è¾“å‡º: ä¸“ä¸šä¼°å€¼æŠ¥å‘Š (Markdown)                        â”‚
â”‚    â€¢ ç­–ç•¥: å•æ¬¡æ·±åº¦æ¨ç†, ä¸“ä¸šæç¤ºè¯, ç»“æ„åŒ–è¾“å‡º           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â”‚ [MarkdownæŠ¥å‘Š]
   â”‚
   â–¼
ä¿å­˜åˆ°æ–‡ä»¶ & è¿”å›ç»“æœ
```

## æ¨¡å—è¯¦è§£

### 1. API Clients å±‚

#### SonarClient (Sonar APIå®¢æˆ·ç«¯)

**èŒè´£**ï¼š
- å°è£…Perplexity Sonar APIè°ƒç”¨
- æä¾›åŒæ­¥å’Œå¼‚æ­¥æœç´¢æ¥å£
- å®ç°å¹¶è¡Œæ‰¹é‡æœç´¢

**æ ¸å¿ƒæ–¹æ³•**ï¼š
```python
class SonarClient:
    def search(query: str) -> Dict
        # å•æ¬¡åŒæ­¥æœç´¢
        
    async def search_async(query: str) -> Dict
        # å•æ¬¡å¼‚æ­¥æœç´¢
        
    async def batch_search_async(queries: List[str]) -> List[Dict]
        # å¹¶è¡Œæ‰¹é‡æœç´¢ï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼‰
        
    def batch_search(queries: List[str]) -> List[Dict]
        # åŒæ­¥åŒ…è£…çš„æ‰¹é‡æœç´¢
```

**å…³é”®ç‰¹æ€§**ï¼š
- âœ… å¼‚æ­¥å¹¶å‘ï¼ˆasyncio + aiohttpï¼‰
- âœ… Semaphoreé™æµæ§åˆ¶
- âœ… è¶…æ—¶å’Œé”™è¯¯å¤„ç†
- âœ… è¿”å›ç»Ÿä¸€æ ¼å¼

#### QwenClient (Qwen3-Max APIå®¢æˆ·ç«¯)

**èŒè´£**ï¼š
- å°è£…Qwen3-Max APIè°ƒç”¨
- æ”¯æŒå¤šè½®å¯¹è¯å’Œå•æ¬¡æç¤º
- æä¾›çµæ´»çš„å‚æ•°æ§åˆ¶

**æ ¸å¿ƒæ–¹æ³•**ï¼š
```python
class QwenClient:
    def chat(messages: List[Dict], ...) -> Dict
        # å¤šè½®å¯¹è¯
        
    def simple_prompt(prompt: str, ...) -> str
        # å•æ¬¡æç¤ºï¼ˆä¾¿æ·æ–¹æ³•ï¼‰
```

**å…³é”®ç‰¹æ€§**ï¼š
- âœ… çµæ´»çš„æ¸©åº¦å’Œtokenæ§åˆ¶
- âœ… ç³»ç»Ÿæç¤ºè¯æ”¯æŒ
- âœ… ä½¿ç”¨ç»Ÿè®¡è¿”å›
- âœ… é”™è¯¯å¤„ç†å’Œé‡è¯•

### 2. Agents å±‚

#### QueryPlannerAgent (æŸ¥è¯¢è§„åˆ’Agent)

**èŒè´£**ï¼šæ™ºèƒ½æŸ¥è¯¢è§„åˆ’ï¼Œå°†åˆ†æéœ€æ±‚åˆ†è§£ä¸ºç²¾ç¡®çš„æœç´¢æŸ¥è¯¢

**è¾“å…¥**ï¼š
```python
{
    "company": "Apple Inc",
    "analysis_type": "valuation"
}
```

**è¾“å‡º**ï¼š
```python
{
    "status": "success",
    "plan": {
        "queries": [
            {
                "query": "Apple Inc Q4 2024 earnings revenue profit",
                "purpose": "æœ€æ–°è´¢åŠ¡æ•°æ®",
                "priority": "high"
            },
            # ... æ›´å¤šæŸ¥è¯¢
        ]
    }
}
```

**ä¼˜åŒ–ç­–ç•¥**ï¼š
- ğŸ¯ ä½tokenæ¶ˆè€—ï¼ˆ~500ï¼‰
- ğŸ¯ JSONç»“æ„åŒ–è¾“å‡º
- ğŸ¯ ä½æ¸©åº¦ï¼ˆ0.3ï¼‰ç¡®ä¿ç²¾ç¡®
- ğŸ¯ å¤‡ç”¨è®¡åˆ’é˜²æ­¢å¤±è´¥

#### InformationCollectorAgent (ä¿¡æ¯æ”¶é›†Agent)

**èŒè´£**ï¼šå¹¶è¡Œæ‰§è¡Œæœç´¢æŸ¥è¯¢ï¼Œå¿«é€Ÿæ”¶é›†å…¨é¢ä¿¡æ¯

**è¾“å…¥**ï¼šQueryPlannerAgentçš„è¾“å‡º

**è¾“å‡º**ï¼š
```python
{
    "status": "success",
    "company": "Apple Inc",
    "results": [
        {
            "query": "...",
            "purpose": "...",
            "priority": "high",
            "content": "...",
            "status": "success"
        },
        # ... æ›´å¤šç»“æœ
    ],
    "success_count": 7,
    "total_queries": 8
}
```

**ä¼˜åŒ–ç­–ç•¥**ï¼š
- âš¡ å¹¶è¡Œæ‰§è¡Œï¼ˆ5ä¸ªå¹¶å‘ï¼‰
- âš¡ æŒ‰ä¼˜å…ˆçº§åˆ†ç±»
- âš¡ æ ¼å¼åŒ–è¾“å‡ºä¾›åˆ†æ
- âš¡ å®¹é”™å¤„ç†

#### DeepAnalystAgent (æ·±åº¦åˆ†æAgent)

**èŒè´£**ï¼šç»¼åˆæ‰€æœ‰ä¿¡æ¯ï¼Œç”Ÿæˆä¸“ä¸šä¼°å€¼æŠ¥å‘Š

**è¾“å…¥**ï¼šæ ¼å¼åŒ–çš„ä¿¡æ¯æ–‡æœ¬

**è¾“å‡º**ï¼š
```python
{
    "status": "success",
    "company": "Apple Inc",
    "report": "# Apple Inc ä¼°å€¼åˆ†æ\n\n## æ‰§è¡Œæ‘˜è¦\n...",
    "report_type": "comprehensive"
}
```

**ä¼˜åŒ–ç­–ç•¥**ï¼š
- ğŸ“Š ä¸“ä¸šçš„ç³»ç»Ÿæç¤ºè¯
- ğŸ“Š å……è¶³çš„æ¨ç†ç©ºé—´ï¼ˆ8000 tokensï¼‰
- ğŸ“Š ç»“æ„åŒ–çš„Markdownè¾“å‡º
- ğŸ“Š å•æ¬¡æ·±åº¦æ¨ç†ï¼ˆé¿å…å¤šè½®ï¼‰

### 3. ä¸»æ§åˆ¶å™¨

#### ValuationReportSystem

**èŒè´£**ï¼šåè°ƒæ‰€æœ‰ç»„ä»¶ï¼Œæä¾›é«˜å±‚API

**æ ¸å¿ƒæ–¹æ³•**ï¼š
```python
class ValuationReportSystem:
    def generate_report(company, ...) -> dict
        # å®Œæ•´æŠ¥å‘Šç”Ÿæˆæµç¨‹
        
    def quick_analysis(company) -> str
        # å¿«é€Ÿæ‘˜è¦ï¼ˆä½æˆæœ¬ï¼‰
        
    def compare_companies(companies: list) -> dict
        # å¤šå…¬å¸æ¯”è¾ƒåˆ†æ
```

**å·¥ä½œæµç¨‹**ï¼š
```python
def generate_report(company):
    # 1. æŸ¥è¯¢è§„åˆ’
    plan = query_planner.generate_search_plan(company)
    
    # 2. ä¿¡æ¯æ”¶é›†
    info = information_collector.collect_information(plan)
    
    # 3. æ·±åº¦åˆ†æ
    report = deep_analyst.generate_valuation_report(company, info)
    
    # 4. ä¿å­˜å’Œè¿”å›
    save_report(report)
    return report
```

## é…ç½®ç³»ç»Ÿ

### config.py å‚æ•°è¯´æ˜

```python
# APIé…ç½®
PERPLEXITY_API_KEY     # Sonar APIå¯†é’¥
PERPLEXITY_API_URL     # Sonar APIç«¯ç‚¹
QWEN_API_KEY           # Qwen APIå¯†é’¥  
QWEN_API_URL           # Qwen APIç«¯ç‚¹

# æ¨¡å‹é€‰æ‹©
SONAR_MODEL = "sonar"       # Sonaræœç´¢æ¨¡å‹
QWEN_MODEL = "qwen-max"     # Qwenæ¨ç†æ¨¡å‹

# æˆæœ¬ä¼˜åŒ–
MAX_SONAR_QUERIES = 8            # æ¯æ¬¡æŸ¥è¯¢æ•°ï¼ˆâ†“é™ä½æˆæœ¬ï¼‰
QUERY_PLANNER_MAX_TOKENS = 500   # è§„åˆ’tokené™åˆ¶
DEEP_ANALYSIS_MAX_TOKENS = 8000  # åˆ†ætokené™åˆ¶ï¼ˆâ†‘æé«˜è´¨é‡ï¼‰

# æ€§èƒ½ä¼˜åŒ–
MAX_CONCURRENT_SEARCHES = 5      # å¹¶å‘æ•°ï¼ˆâ†‘æé«˜é€Ÿåº¦ï¼‰

# ç¼“å­˜ï¼ˆæœªæ¥åŠŸèƒ½ï¼‰
ENABLE_CACHE = True              # æ˜¯å¦å¯ç”¨ç¼“å­˜
CACHE_EXPIRY_HOURS = 6           # ç¼“å­˜è¿‡æœŸæ—¶é—´
```

## é”™è¯¯å¤„ç†æœºåˆ¶

### åˆ†å±‚é”™è¯¯å¤„ç†

```
1. APIå±‚
   â”œâ”€ ç½‘ç»œé”™è¯¯ -> è¿”å›errorçŠ¶æ€
   â”œâ”€ è®¤è¯é”™è¯¯ -> æŠ›å‡ºå¼‚å¸¸
   â””â”€ è¶…æ—¶é”™è¯¯ -> è‡ªåŠ¨é‡è¯•

2. Agentå±‚
   â”œâ”€ æŸ¥è¯¢è§„åˆ’å¤±è´¥ -> ä½¿ç”¨å¤‡ç”¨è®¡åˆ’
   â”œâ”€ éƒ¨åˆ†æœç´¢å¤±è´¥ -> ä½¿ç”¨æˆåŠŸçš„ç»“æœ
   â””â”€ åˆ†æå¤±è´¥ -> è¿”å›errorçŠ¶æ€

3. ç³»ç»Ÿå±‚
   â”œâ”€ éªŒè¯è¾“å…¥å‚æ•°
   â”œâ”€ è®°å½•è¯¦ç»†æ—¥å¿—
   â””â”€ è¿”å›æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯
```

## æ‰©å±•ç‚¹

ç³»ç»Ÿè®¾è®¡äº†å¤šä¸ªæ‰©å±•ç‚¹ï¼š

### 1. æ–°çš„ä¿¡æ¯æº

```python
class CustomDataCollector(InformationCollectorAgent):
    def collect_from_bloomberg(self, query):
        # é›†æˆå½­åšæ•°æ®
        pass
```

### 2. æ–°çš„åˆ†æç±»å‹

```python
class ESGAnalyst(DeepAnalystAgent):
    def generate_esg_report(self, company, info):
        # ESGä¸“é¡¹åˆ†æ
        pass
```

### 3. æ–°çš„è¾“å‡ºæ ¼å¼

```python
class PDFReportGenerator:
    def generate_pdf(self, markdown_report):
        # è½¬æ¢ä¸ºPDF
        pass
```

### 4. ç¼“å­˜å±‚

```python
class CacheManager:
    def get_cached_result(self, query_hash):
        # ä»ç¼“å­˜è¯»å–
        pass
    
    def save_to_cache(self, query_hash, result):
        # ä¿å­˜åˆ°ç¼“å­˜
        pass
```

## æ€§èƒ½æŒ‡æ ‡

### å…¸å‹æ‰§è¡Œæ—¶é—´

| é˜¶æ®µ | è€—æ—¶ | å æ¯” |
|------|------|------|
| æŸ¥è¯¢è§„åˆ’ | 2-5s | 10% |
| ä¿¡æ¯æ”¶é›† | 30-60s | 60% |
| æ·±åº¦åˆ†æ | 20-40s | 30% |
| **æ€»è®¡** | **2-3åˆ†é’Ÿ** | **100%** |

### èµ„æºæ¶ˆè€—

| èµ„æº | æ¶ˆè€—é‡ |
|------|--------|
| Qwen Tokens | ~8,500 |
| Sonar Queries | 8æ¬¡ |
| å†…å­˜å ç”¨ | <100MB |
| ç½‘ç»œå¸¦å®½ | <5MB |

## å®‰å…¨è€ƒè™‘

1. **APIå¯†é’¥ä¿æŠ¤**ï¼šå­˜å‚¨åœ¨config.pyï¼Œä¸æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
2. **è¾“å…¥éªŒè¯**ï¼šéªŒè¯ç”¨æˆ·è¾“å…¥ï¼Œé˜²æ­¢æ³¨å…¥
3. **é”™è¯¯ä¿¡æ¯**ï¼šä¸æš´éœ²æ•æ„Ÿçš„å†…éƒ¨ä¿¡æ¯
4. **é€Ÿç‡é™åˆ¶**ï¼šSemaphoreæ§åˆ¶å¹¶å‘ï¼Œé¿å…è§¦å‘APIé™æµ

## æ€»ç»“

æœ¬ç³»ç»Ÿé€šè¿‡**ä¸‰å±‚æ¶æ„**å®ç°äº†ï¼š
- âœ… æˆæœ¬ä¼˜åŒ–ï¼ˆç²¾ç¡®æŸ¥è¯¢+å¹¶è¡Œæ‰§è¡Œ+å•æ¬¡æ¨ç†ï¼‰
- âœ… é€Ÿåº¦ä¼˜åŒ–ï¼ˆå¼‚æ­¥å¹¶å‘+æ‰¹é‡å¤„ç†ï¼‰
- âœ… è´¨é‡ä¿è¯ï¼ˆå®æ—¶ä¿¡æ¯+æ·±åº¦æ¨ç†+ä¸“ä¸šæ¡†æ¶ï¼‰
- âœ… æ˜“äºæ‰©å±•ï¼ˆæ¨¡å—åŒ–è®¾è®¡+æ¸…æ™°æ¥å£ï¼‰

è¿™å°±æ˜¯ç³»ç»Ÿèƒ½å¤Ÿ"ä¼˜äºsonar-deep-research"çš„æ¶æ„åŸºç¡€ï¼

