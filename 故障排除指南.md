# 故障排除指南 🔧

## 常见问题及解决方案

### 1. ❌ SSL证书验证失败

**错误信息**:
```
SSL: CERTIFICATE_VERIFY_FAILED
```

**原因**: Qwen API的SSL证书问题

**解决方案**: ✅ 已自动修复
- 系统已配置为跳过SSL验证
- 如果仍有问题，确保已更新到最新代码

---

### 2. ❌ 分析失败或返回空白

**可能原因**:
1. API密钥错误
2. 网络连接问题
3. API限流
4. Token超限

**解决步骤**:

#### Step 1: 测试API连接
```bash
python test_quick.py
```

#### Step 2: 检查API密钥
编辑 `config.py`:
```python
PERPLEXITY_API_KEY = "pplx-你的密钥"
QWEN_API_KEY = "sk-你的密钥"
```

#### Step 3: 检查网络
```bash
ping api.nuwaapi.com
ping api.perplexity.ai
```

#### Step 4: 降低Token限制
如果报告太长导致超时，编辑 `config.py`:
```python
DEEP_ANALYSIS_MAX_TOKENS = 4000  # 从8000降低到4000
MAX_SONAR_QUERIES = 5  # 从8减少到5
```

---

### 3. 🌐 Web界面打不开

**问题**: 浏览器无法访问 localhost:8501

**解决方案**:

#### 方法1: 手动输入地址
在浏览器地址栏输入:
```
http://localhost:8501
```

#### 方法2: 检查端口占用
```bash
lsof -i :8501
```

如果端口被占用，更换端口:
```bash
streamlit run web_app.py --server.port 8502
```

#### 方法3: 检查Streamlit是否运行
在终端应该看到:
```
You can now view your Streamlit app in your browser.
Local URL: http://localhost:8501
```

如果没有，重新启动:
```bash
streamlit run web_app.py
```

---

### 4. ⚠️ 报告显示为HTML代码

**问题**: 报告内容显示为原始HTML标签

**原因**: HTML渲染未启用

**解决方案**: ✅ 已修复
- Web界面已更新为正确渲染HTML
- 使用专业CSS样式
- 自动格式化表格和链接

**确认更新**:
```bash
# 重启Web服务
# 按 Ctrl+C 停止
# 然后重新运行
streamlit run web_app.py
```

---

### 5. 📊 表格显示不正确

**问题**: 数据表格格式混乱

**解决方案**:

确保使用最新版本:
```bash
git pull  # 如果使用git
# 或重新下载代码
```

清除Streamlit缓存:
```bash
streamlit cache clear
```

---

### 6. 🐌 分析速度太慢

**原因**: 网络延迟或API响应慢

**优化方案**:

#### 方法1: 使用快速分析
```python
system.quick_analysis("公司名")  # 快30-60秒
```

#### 方法2: 减少查询数量
编辑 `config.py`:
```python
MAX_SONAR_QUERIES = 5  # 减少查询数
```

#### 方法3: 增加并发数
编辑 `config.py`:
```python
MAX_CONCURRENT_SEARCHES = 8  # 提高并发
```

---

### 7. 💰 成本太高

**优化策略**:

#### 方法1: 使用快速模式
```python
system.quick_analysis("公司名")  # 成本降低70%
```

#### 方法2: 降低Token限制
编辑 `config.py`:
```python
QUERY_PLANNER_MAX_TOKENS = 300  # 从500降到300
DEEP_ANALYSIS_MAX_TOKENS = 4000  # 从8000降到4000
MAX_SONAR_QUERIES = 5  # 从8减到5
```

预期成本降低: **约50%**

---

### 8. ❌ ModuleNotFoundError

**错误信息**:
```
ModuleNotFoundError: No module named 'streamlit'
```

**解决方案**:
```bash
pip install -r requirements.txt
```

或单独安装:
```bash
pip install streamlit
pip install requests
pip install aiohttp
```

---

### 9. 🔑 API密钥错误

**错误信息**:
```
401 Unauthorized
403 Forbidden
```

**解决步骤**:

1. 确认API密钥正确
2. 检查密钥是否过期
3. 确认密钥有足够配额

编辑 `config.py`:
```python
# Perplexity Sonar
PERPLEXITY_API_KEY = "pplx-您的完整密钥"

# Qwen3-Max  
QWEN_API_KEY = "sk-您的完整密钥"
```

---

### 10. 📝 报告质量不满意

**提升质量的方法**:

#### 方法1: 使用完整公司名
❌ 坏: "苹果", "特斯拉"
✅ 好: "Apple Inc", "Tesla Inc"

#### 方法2: 增加分析深度
编辑 `config.py`:
```python
MAX_SONAR_QUERIES = 12  # 更多信息
DEEP_ANALYSIS_MAX_TOKENS = 12000  # 更深入分析
```

#### 方法3: 多次分析取平均
对重要决策，建议分析2-3次

---

### 11. 🔄 Web界面卡住

**症状**: 进度条不动，页面无响应

**解决方案**:

#### 方法1: 刷新页面
按 `F5` 或 `Ctrl+R`

#### 方法2: 重启服务
```bash
# 停止: Ctrl+C
# 重启
streamlit run web_app.py
```

#### 方法3: 清除缓存
点击页面右上角菜单 → Clear cache

---

### 12. 🚫 端口8501被占用

**错误信息**:
```
Port 8501 is already in use
```

**解决方案**:

#### 方法1: 杀死占用进程
```bash
lsof -ti:8501 | xargs kill -9
```

#### 方法2: 使用其他端口
```bash
streamlit run web_app.py --server.port 8502
```

然后访问: http://localhost:8502

---

## 🧪 诊断工具

### 快速诊断脚本
```bash
python test_quick.py
```

这会测试:
- ✅ 模块导入
- ✅ 系统初始化
- ✅ Qwen API连接
- ✅ Sonar API连接
- ✅ 快速分析功能

### 完整测试
```bash
python test_system.py
```

测试所有功能:
- API连接
- 查询规划
- 信息收集
- 快速分析
- 完整报告

---

## 📞 获取帮助

### 查看日志
终端会显示详细的执行日志:
- 🔍 查询规划进度
- 📊 搜索结果统计
- 🤔 分析过程
- ✅ 完成状态

### 常见错误代码

| 错误码 | 含义 | 解决方法 |
|--------|------|---------|
| 401 | API密钥无效 | 检查config.py |
| 403 | 无权限访问 | 确认API配额 |
| 429 | 请求过多 | 降低并发数 |
| 500 | 服务器错误 | 稍后重试 |
| 503 | 服务不可用 | 检查网络 |

---

## 💡 最佳实践

1. **首次使用**: 先运行 `test_quick.py` 确保一切正常
2. **大公司优先**: 从Apple、Microsoft等知名公司开始测试
3. **使用英文名**: 搜索效果更好
4. **保存报告**: 启用自动保存功能
5. **定期更新**: 每季度财报后重新分析

---

## 🔄 重置系统

如果遇到无法解决的问题，完全重置:

```bash
# 1. 停止所有运行的服务
# Ctrl+C

# 2. 清除Python缓存
find . -type d -name "__pycache__" -exec rm -rf {} +
find . -type f -name "*.pyc" -delete

# 3. 重新安装依赖
pip install --force-reinstall -r requirements.txt

# 4. 重启Web服务
streamlit run web_app.py
```

---

## ✅ 确认系统正常

运行以下命令确认一切正常:

```bash
# 1. 测试API
python test_quick.py

# 2. 启动Web界面
streamlit run web_app.py

# 3. 访问浏览器
# http://localhost:8501

# 4. 测试分析
# 输入"Apple Inc"点击分析
```

如果以上都正常，系统已就绪！🎉

---

**需要更多帮助?**
查看 `README.md` 或 `使用指南.md` 获取详细文档。

