# 深度估值报告系统 - 中文使用指南 📚

## 系统简介

这是一个结合了**Perplexity Sonar实时搜索**和**Qwen3-Max深度推理**的智能估值分析系统。通过三层优化架构，在保证信息实时性的同时，提供超越sonar-deep-research的深度分析质量，且成本更低。

## 核心优势

✅ **实时信息**：Sonar API确保获取最新的新闻、数据和市场动态  
✅ **深度推理**：Qwen3-Max提供专业级的投资分析  
✅ **成本优化**：三层架构设计，节省30-40%成本  
✅ **速度快**：并行搜索，速度提升2-3倍  
✅ **专业输出**：遵循投资分析行业标准的结构化报告  

## 快速开始

### 1. 安装依赖

```bash
pip install requests aiohttp asyncio python-dotenv pydantic rich
```

或者：

```bash
pip install -r requirements.txt
```

### 2. 第一次使用

```python
from main import ValuationReportSystem

# 创建系统实例
system = ValuationReportSystem()

# 生成报告（会自动保存到reports目录）
result = system.generate_report("苹果公司")

# 查看报告
print(result["report"])
```

### 3. 查看生成的报告

报告会自动保存在 `reports/` 目录，使用Markdown格式，可以用任何文本编辑器或Markdown查看器打开。

## 使用场景

### 场景一：单个公司深度估值

```python
from main import ValuationReportSystem

system = ValuationReportSystem()

# 生成完整的估值报告
result = system.generate_report(
    company="特斯拉",              # 公司名称
    analysis_type="valuation",    # 分析类型：估值分析
    report_type="comprehensive",  # 报告类型：综合报告
    save_to_file=True            # 保存到文件
)

# 打印报告
print(result["report"])

# 查看元数据
print(f"查询数量: {result['metadata']['queries_executed']}")
print(f"耗时: {result['metadata']['elapsed_time']:.2f}秒")
print(f"文件位置: {result['metadata']['saved_file']}")
```

### 场景二：快速分析（降低成本）

如果你只需要快速了解一个公司的投资要点，可以使用快速分析模式：

```python
system = ValuationReportSystem()

# 快速分析（成本约为完整报告的30%）
summary = system.quick_analysis("比亚迪")

print(summary)
```

### 场景三：比较多个公司

```python
system = ValuationReportSystem()

# 比较分析（适合选股决策）
companies = ["苹果", "微软", "谷歌"]
comparison = system.compare_companies(companies)

print(comparison["comparison"])
```

### 场景四：批量生成报告

```python
system = ValuationReportSystem()

# 批量分析你的关注列表
watchlist = [
    "英伟达",
    "台积电", 
    "AMD",
    "英特尔"
]

for company in watchlist:
    print(f"\n正在分析: {company}")
    result = system.generate_report(company, save_to_file=True)
    
    if result["status"] == "success":
        print(f"✅ {company} 分析完成")
        print(f"   文件: {result['metadata']['saved_file']}")
    else:
        print(f"❌ {company} 分析失败: {result.get('error')}")
```

## 配置说明

在 `config.py` 中可以调整系统参数：

```python
# API配置（已设置）
PERPLEXITY_API_KEY = "pplx-..."  # 你的Sonar API密钥
QWEN_API_KEY = "sk-..."           # 你的Qwen API密钥

# 成本优化参数
MAX_SONAR_QUERIES = 8              # 每次分析的查询数（减少=降低成本）
QUERY_PLANNER_MAX_TOKENS = 500     # 查询规划token限制
DEEP_ANALYSIS_MAX_TOKENS = 8000    # 深度分析token限制（增加=更详细）

# 性能参数
MAX_CONCURRENT_SEARCHES = 5        # 并发搜索数（增加=更快）
```

### 如何调整成本和质量？

**降低成本**：
```python
MAX_SONAR_QUERIES = 5              # 从8减到5
DEEP_ANALYSIS_MAX_TOKENS = 4000    # 从8000减到4000
# 成本降低约40%，质量略有下降
```

**提高质量**：
```python
MAX_SONAR_QUERIES = 12             # 从8增到12
DEEP_ANALYSIS_MAX_TOKENS = 12000   # 从8000增到12000
# 质量显著提升，成本增加约50%
```

**加快速度**：
```python
MAX_CONCURRENT_SEARCHES = 8        # 从5增到8
# 速度提升，但请注意API限流
```

## 报告结构

生成的估值报告通常包含以下部分：

### 1. 执行摘要
- 核心投资论点
- 目标价和评级
- 关键风险提示

### 2. 公司概况
- 业务模式
- 核心产品/服务
- 市场地位

### 3. 财务分析
- 最新财报数据
- 营收和利润趋势
- 现金流状况
- 关键财务比率

### 4. 估值分析
- 相对估值（P/E, P/S, P/B等）
- 与同行业比较
- 历史估值区间
- 合理估值区间

### 5. 增长驱动因素
- 短期催化剂
- 长期增长逻辑
- 市场机会

### 6. 风险因素
- 业务风险
- 财务风险
- 市场风险
- 监管风险

### 7. 投资建议
- 买入/持有/卖出评级
- 目标价区间
- 投资时间框架

## 运行示例

### 运行完整示例

```bash
python examples.py
```

这会显示一个菜单，让你选择不同的示例：
1. 基本估值报告
2. 快速分析模式
3. 比较分析
4. 批量分析
5. 自定义分析

### 测试系统

```bash
# 运行所有测试
python test_system.py

# 运行特定测试
python test_system.py api       # 测试API连接
python test_system.py quick     # 测试快速分析
python test_system.py full      # 测试完整报告
```

## 常见问题

### Q1: 报告生成需要多长时间？

**快速分析**：30-60秒  
**完整报告**：2-3分钟  
**比较分析**：5-10分钟（取决于公司数量）

### Q2: 一份报告大概花费多少？

基于当前的API定价：
- **快速分析**：约 $0.02 per report
- **标准报告**：约 $0.044 per report
- **深度报告**：约 $0.07 per report

具体取决于你的API定价和配置。

### Q3: 可以分析哪些公司？

任何公开交易的公司、知名私企，甚至行业和主题。例如：
- 上市公司：苹果、特斯拉、茅台、腾讯
- 知名私企：OpenAI、SpaceX
- 行业：半导体行业、电动车行业
- 主题：人工智能投资机会

### Q4: 支持中文公司名吗？

完全支持！系统会智能处理中英文：
```python
system.generate_report("贵州茅台")
system.generate_report("Kweichow Moutai")
# 都可以
```

### Q5: 报告准确性如何？

报告基于：
- ✅ Sonar的实时搜索（确保信息最新）
- ✅ Qwen3-Max的深度推理（确保分析专业）
- ⚠️ 但请注意：这是AI生成的分析，仅供参考，不构成投资建议

### Q6: 如何提高报告质量？

1. **增加查询数量**：`MAX_SONAR_QUERIES = 12`
2. **增加分析深度**：`DEEP_ANALYSIS_MAX_TOKENS = 12000`
3. **使用英文公司名**：通常能获取更多信息
4. **提供更具体的名称**：如"NVIDIA Corporation"而不是"英伟达"

### Q7: 系统能否离线使用？

不能，系统需要：
- Perplexity Sonar API（实时搜索）
- Qwen3-Max API（深度推理）

两者都需要网络连接。

### Q8: 出现错误怎么办？

常见错误解决：

**API连接失败**：
```python
# 检查API密钥是否正确
# 检查网络连接
python test_system.py api
```

**查询规划失败**：
```python
# 系统会自动使用备用查询计划
# 不影响最终结果
```

**信息收集失败**：
```python
# 部分查询失败不影响整体
# 系统会使用成功的查询继续分析
```

## 高级用法

### 自定义查询计划

如果你想完全控制搜索的内容：

```python
from agents import InformationCollectorAgent, DeepAnalystAgent

# 自定义查询计划
custom_plan = {
    "status": "success",
    "company": "特斯拉",
    "plan": {
        "queries": [
            {
                "query": "特斯拉2024年第四季度财报 交付量",
                "purpose": "最新交付数据",
                "priority": "high"
            },
            {
                "query": "特斯拉FSD自动驾驶最新进展",
                "purpose": "技术进展",
                "priority": "high"
            },
            # ... 添加更多查询
        ]
    }
}

# 使用自定义计划
collector = InformationCollectorAgent()
info = collector.collect_information(custom_plan)

analyst = DeepAnalystAgent()
report = analyst.generate_valuation_report(
    "特斯拉",
    collector.format_for_analysis(info)
)
```

### 扩展系统功能

系统采用模块化设计，易于扩展：

```python
# 添加新的分析维度
class ESGAnalystAgent(DeepAnalystAgent):
    def generate_esg_report(self, company, info):
        # 专注于ESG分析的报告
        pass

# 添加新的信息源
class CustomDataCollector(InformationCollectorAgent):
    def collect_from_custom_api(self, company):
        # 从其他数据源收集信息
        pass
```

## 最佳实践

1. **首次使用**：从快速分析开始，了解输出格式
2. **批量分析**：使用循环处理多个公司，节省时间
3. **定期更新**：市场变化快，建议每周更新分析
4. **交叉验证**：对重要决策，建议人工审核报告
5. **保存历史**：reports目录保存了所有历史报告，便于追踪

## 技术支持

- 查看 `README.md` - 完整文档
- 查看 `OPTIMIZATION_STRATEGY.md` - 优化策略详解
- 查看 `QUICKSTART.md` - 快速入门
- 运行 `test_system.py` - 诊断问题

---

**祝你投资顺利！** 📈

