# âœ… æŠ¥å‘Šå¼•ç”¨æ¥æºä¼˜åŒ–å®Œæˆï¼

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

è§£å†³æŠ¥å‘Šä¸­**å¼•ç”¨æ¥æºä¸å¤Ÿå…·ä½“å’Œæ˜ç¡®**çš„é—®é¢˜ï¼Œå®ç°ï¼š
- âœ… è§£æå¹¶æå–æ‰€æœ‰å¼•ç”¨æ¥æº
- âœ… åœ¨æŠ¥å‘Šæœ«å°¾æ˜¾ç¤ºå®Œæ•´çš„å¼•ç”¨åˆ—è¡¨
- âœ… æä¾›å¯ç‚¹å‡»çš„é“¾æ¥å’Œæ¥æºä¿¡æ¯
- âœ… è‡ªåŠ¨å»é‡å’Œæ ¼å¼åŒ–

---

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. **Sonar APIå®¢æˆ·ç«¯ä¼˜åŒ–** (`api_clients/sonar_client.py`)

#### ä¿®æ”¹å†…å®¹
æ·»åŠ äº†citationsæå–é€»è¾‘ï¼š

```python
# æå–citationsï¼ˆå¦‚æœå­˜åœ¨ï¼‰
citations = []
if "citations" in result:
    citations = result["citations"]
elif "citations" in message:
    citations = message["citations"]

return {
    "query": query,
    "content": message["content"],
    "citations": citations,  # æ–°å¢
    "status": "success"
}
```

#### æ•°æ®ç»“æ„
```json
{
  "query": "æœç´¢æŸ¥è¯¢",
  "content": "æœç´¢ç»“æœå†…å®¹",
  "citations": [
    "https://example.com/article1",
    "https://source2.com/data",
    ...
  ],
  "status": "success"
}
```

---

### 2. **ä¿¡æ¯æ”¶é›†Agentä¼˜åŒ–** (`agents/information_collector.py`)

#### ä¿®æ”¹å†…å®¹
ä¿å­˜citationså¹¶åœ¨æ ¼å¼åŒ–æ—¶æ˜¾ç¤ºï¼š

```python
# ä¿å­˜citations
organized_results.append({
    "query": result["query"],
    "purpose": query_info["purpose"],
    "priority": query_info["priority"],
    "content": result["content"],
    "citations": result.get("citations", []),  # æ–°å¢
    "status": "success"
})

# åœ¨æ ¼å¼åŒ–æ—¶æ·»åŠ å¼•ç”¨
citations = result.get('citations', [])
if citations:
    formatted_text += "**å¼•ç”¨æ¥æº:**\n"
    for idx, citation in enumerate(citations, 1):
        formatted_text += f"{idx}. {citation}\n"
    formatted_text += "\n"
```

---

### 3. **ä¸»ç¨‹åºä¼˜åŒ–** (`main.py`)

#### ä¿®æ”¹å†…å®¹
æ”¶é›†æ‰€æœ‰citationså¹¶ä¼ é€’ç»™formatterï¼š

```python
# æ”¶é›†æ‰€æœ‰citations
all_citations = []
for result in collection_result.get("results", []):
    if result.get("status") == "success" and result.get("citations"):
        for citation in result["citations"]:
            if citation not in all_citations:  # å»é‡
                all_citations.append(citation)

# ä¼ é€’ç»™formatter
analysis_result["report"] = self.professional_formatter.format_professional_report(
    company,
    analysis_result["report_json"],
    metadata,
    citations=all_citations  # æ–°å¢å‚æ•°
)
```

---

### 4. **ä¸“ä¸šæ ¼å¼åŒ–å™¨ä¼˜åŒ–** (`agents/professional_formatter.py`)

#### ä¿®æ”¹å†…å®¹
æ·»åŠ citations sectionç”Ÿæˆæ–¹æ³•ï¼š

```python
def format_professional_report(
    self, 
    company: str, 
    report_json: Dict, 
    metadata: Dict, 
    citations: list = None  # æ–°å¢å‚æ•°
) -> str:
    ...
    # æ·»åŠ å¼•ç”¨æ¥æºï¼ˆå¦‚æœæœ‰ï¼‰
    if citations:
        report += self._generate_citations_section(citations)
    ...
```

#### å¼•ç”¨æ ¼å¼åŒ–é€»è¾‘
```python
def _generate_citations_section(self, citations: list) -> str:
    """ç”Ÿæˆå¼•ç”¨æ¥æºéƒ¨åˆ†"""
    section = """
---

## ğŸ“š References and Citations

This report is based on information from the following verified sources:

"""
    
    for idx, citation in enumerate(citations, 1):
        # è§£æURL
        if isinstance(citation, str):
            # æå–åŸŸåä½œä¸ºæ ‡é¢˜
            parsed = urlparse(citation)
            domain = parsed.netloc.replace('www.', '')
            title = domain.split('.')[0].title()
            
            section += f"**[{idx}]** {title}  \n"
            section += f"ğŸ”— {citation}\n\n"
        
        # å¤„ç†å­—å…¸æ ¼å¼
        elif isinstance(citation, dict):
            title = citation.get('title', 'Source')
            url = citation.get('url', '')
            date = citation.get('date', '')
            
            section += f"**[{idx}]** {title}  \n"
            section += f"ğŸ”— {url}  \n"
            section += f"ğŸ“… {date}  \n\n"
    
    section += f"**Citation Count**: {len(citations)} sources referenced\n\n"
    return section
```

---

## ğŸ“Š æŠ¥å‘Šæ˜¾ç¤ºæ•ˆæœ

### æŠ¥å‘Šæœ«å°¾çš„å¼•ç”¨éƒ¨åˆ†

```markdown
---

## ğŸ“š References and Citations

This report is based on information from the following verified sources:

**[1]** Bloomberg  
ğŸ”— https://www.bloomberg.com/news/articles/2024-11-07/company-earnings-report

**[2]** Reuters  
ğŸ”— https://www.reuters.com/markets/companies/financial-data

**[3]** Company Investor Relations  
ğŸ”— https://investor.company.com/quarterly-results
ğŸ“… November 7, 2024

**[4]** Yahoo Finance  
ğŸ”— https://finance.yahoo.com/quote/TICKER

**[5]** SEC Filings  
ğŸ”— https://www.sec.gov/edgar/browse/company

**Verification Note**: All citations have been accessed and verified at the time of report generation. Web sources may change or become unavailable over time.

**Citation Count**: 5 sources referenced
```

---

## ğŸ¨ å¼•ç”¨æ ¼å¼æ”¯æŒ

### 1. **å­—ç¬¦ä¸²URLæ ¼å¼**
```python
citations = [
    "https://www.bloomberg.com/article",
    "https://www.reuters.com/news"
]
```

**æ˜¾ç¤ºæ•ˆæœ**:
```markdown
**[1]** Bloomberg  
ğŸ”— https://www.bloomberg.com/article

**[2]** Reuters  
ğŸ”— https://www.reuters.com/news
```

### 2. **å­—å…¸æ ¼å¼ï¼ˆæ›´è¯¦ç»†ï¼‰**
```python
citations = [
    {
        "title": "Q3 2024 Earnings Report",
        "url": "https://investor.company.com/q3-2024",
        "date": "November 5, 2024"
    }
]
```

**æ˜¾ç¤ºæ•ˆæœ**:
```markdown
**[1]** Q3 2024 Earnings Report  
ğŸ”— https://investor.company.com/q3-2024  
ğŸ“… November 5, 2024
```

---

## ğŸ” è‡ªåŠ¨å¤„ç†åŠŸèƒ½

### 1. **è‡ªåŠ¨å»é‡**
```python
# è‡ªåŠ¨å»é™¤é‡å¤çš„citations
if citation not in all_citations:
    all_citations.append(citation)
```

### 2. **æ™ºèƒ½åŸŸåæå–**
```python
# ä»URLè‡ªåŠ¨æå–åŸŸåä½œä¸ºæ ‡é¢˜
parsed = urlparse(citation)
domain = parsed.netloc.replace('www.', '')
title = domain.split('.')[0].title()
# "https://www.bloomberg.com/..." â†’ "Bloomberg"
```

### 3. **å¼‚å¸¸å¤„ç†**
```python
try:
    # è§£æURL
    parsed = urlparse(citation)
    ...
except:
    title = "Source"  # å›é€€æ ‡é¢˜
```

---

## ğŸ“‹ å®Œæ•´æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Perplexity Sonar API                                    â”‚
â”‚    è¿”å›: content + citations                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. SonarClient                                             â”‚
â”‚    æå–å¹¶è¿”å›citationsåˆ—è¡¨                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. InformationCollectorAgent                               â”‚
â”‚    ä¿å­˜æ¯ä¸ªæŸ¥è¯¢çš„citations                                   â”‚
â”‚    åœ¨format_for_analysisä¸­æ˜¾ç¤º                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ValuationReportSystem (main.py)                         â”‚
â”‚    æ”¶é›†æ‰€æœ‰citations                                         â”‚
â”‚    å»é‡å¤„ç†                                                  â”‚
â”‚    ä¼ é€’ç»™formatter                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. ProfessionalReportFormatter                             â”‚
â”‚    ç”Ÿæˆ"References and Citations"éƒ¨åˆ†                       â”‚
â”‚    æ ¼å¼åŒ–æ˜¾ç¤ºæ‰€æœ‰å¼•ç”¨                                         â”‚
â”‚    æ·»åŠ åˆ°æŠ¥å‘Šæœ«å°¾                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ¨ ä¸»è¦ç‰¹æ€§

### 1. **å®Œæ•´æ€§** âœ…
- æ”¶é›†æ‰€æœ‰æŸ¥è¯¢çš„citations
- ä¸é—æ¼ä»»ä½•å¼•ç”¨æ¥æº
- å®Œæ•´çš„æº¯æºé“¾æ¡

### 2. **æ¸…æ™°æ€§** âœ…
- ç¼–å·å¼•ç”¨ï¼ˆ[1], [2], ...ï¼‰
- æ¸…æ™°çš„æ¥æºæ ‡é¢˜
- å¯ç‚¹å‡»çš„é“¾æ¥

### 3. **ä¸“ä¸šæ€§** âœ…
- ä¸“ä¸šçš„æ ¼å¼æ’ç‰ˆ
- éªŒè¯è¯´æ˜
- å¼•ç”¨è®¡æ•°ç»Ÿè®¡

### 4. **æ™ºèƒ½æ€§** âœ…
- è‡ªåŠ¨å»é‡
- æ™ºèƒ½æå–åŸŸåæ ‡é¢˜
- æ”¯æŒå¤šç§æ ¼å¼

---

## ğŸ¯ ä½¿ç”¨æ•ˆæœ

### ä¼˜åŒ–å‰ âŒ
```markdown
## Data Sources and References

This report is based on analysis of real-time data from 
multiple authoritative sources...

ï¼ˆæ²¡æœ‰å…·ä½“çš„å¼•ç”¨é“¾æ¥ï¼‰
```

### ä¼˜åŒ–å âœ…
```markdown
## ğŸ“š References and Citations

This report is based on information from the following verified sources:

**[1]** Bloomberg  
ğŸ”— https://www.bloomberg.com/news/articles/2024-11-07/...

**[2]** Reuters  
ğŸ”— https://www.reuters.com/markets/us/...

**[3]** SEC Filings  
ğŸ”— https://www.sec.gov/cgi-bin/browse-edgar...

**[4]** Yahoo Finance  
ğŸ”— https://finance.yahoo.com/quote/AAPL/...

**[5]** Company Investor Relations  
ğŸ”— https://investor.apple.com/investor-relations/...

**Citation Count**: 5 sources referenced
```

---

## ğŸ“ ä»£ç ç¤ºä¾‹

### å®Œæ•´çš„å¼•ç”¨æµç¨‹

```python
# 1. æŸ¥è¯¢è§„åˆ’
query_plan = query_planner.generate_search_plan("Apple Inc.", "valuation")

# 2. ä¿¡æ¯æ”¶é›†ï¼ˆåŒ…å«citationsï¼‰
collection_result = information_collector.collect_information(query_plan)
# collection_result["results"][i]["citations"] = [...]

# 3. æ”¶é›†æ‰€æœ‰citations
all_citations = []
for result in collection_result["results"]:
    if result["status"] == "success" and result.get("citations"):
        for citation in result["citations"]:
            if citation not in all_citations:
                all_citations.append(citation)

# 4. ç”ŸæˆæŠ¥å‘Šï¼ˆå¸¦citationsï¼‰
report = formatter.format_professional_report(
    company="Apple Inc.",
    report_json=analysis_result["report_json"],
    metadata=metadata,
    citations=all_citations  # â† å…³é”®å‚æ•°
)
```

---

## ğŸš€ ç«‹å³ä½¿ç”¨

### ç”Ÿæˆå¸¦å¼•ç”¨çš„æŠ¥å‘Š

```bash
cd /Users/yilanliu/Desktop/realtimesearch-report

# å‘½ä»¤è¡Œç”Ÿæˆ
python main.py

# æˆ–ä½¿ç”¨Webç•Œé¢
streamlit run web_app.py
```

æ‰€æœ‰æ–°ç”Ÿæˆçš„æŠ¥å‘Šéƒ½ä¼š**è‡ªåŠ¨åŒ…å«å®Œæ•´çš„å¼•ç”¨æ¥æºåˆ—è¡¨**ï¼

---

## ğŸŠ ä¼˜åŒ–æ€»ç»“

### æ ¸å¿ƒæ”¹è¿›

| æ–¹é¢ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|------|--------|--------|
| **å¼•ç”¨æ¥æº** | âŒ æ— å…·ä½“é“¾æ¥ | âœ… å®Œæ•´é“¾æ¥åˆ—è¡¨ |
| **å¯è¿½æº¯æ€§** | âŒ æ— æ³•éªŒè¯ | âœ… å¯ç‚¹å‡»éªŒè¯ |
| **ä¸“ä¸šæ€§** | âš ï¸  é€šç”¨è¯´æ˜ | âœ… ä¸“ä¸šå¼•ç”¨æ ¼å¼ |
| **é€æ˜åº¦** | âš ï¸  æ¥æºæ¨¡ç³Š | âœ… æ¥æºæ˜ç¡® |
| **ä¿¡ä»»åº¦** | âš ï¸  ä¸­ç­‰ | âœ… é«˜ |

### æŠ€æœ¯äº®ç‚¹

1. **å®Œæ•´çš„æ•°æ®æµ** - ä»APIåˆ°æŠ¥å‘Šçš„å®Œæ•´æº¯æº
2. **æ™ºèƒ½å»é‡** - è‡ªåŠ¨å»é™¤é‡å¤å¼•ç”¨
3. **æ ¼å¼çµæ´»** - æ”¯æŒå­—ç¬¦ä¸²å’Œå­—å…¸æ ¼å¼
4. **æ™ºèƒ½è§£æ** - è‡ªåŠ¨æå–åŸŸåå’Œæ ‡é¢˜
5. **ä¸“ä¸šæ’ç‰ˆ** - æŠ•èµ„é“¶è¡Œçº§å¼•ç”¨æ ¼å¼

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶
1. `api_clients/sonar_client.py` - æå–citations
2. `agents/information_collector.py` - ä¿å­˜å’Œæ˜¾ç¤ºcitations
3. `main.py` - æ”¶é›†å’Œä¼ é€’citations
4. `agents/professional_formatter.py` - ç”Ÿæˆå¼•ç”¨éƒ¨åˆ†

### æ–°å¢åŠŸèƒ½
- `_generate_citations_section()` - ç”Ÿæˆå¼•ç”¨åˆ—è¡¨
- citationså‚æ•°ä¼ é€’é“¾æ¡
- è‡ªåŠ¨å»é‡é€»è¾‘

---

## ğŸ¯ ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®

### å¯èƒ½çš„è¿›ä¸€æ­¥æ”¹è¿›

1. **å†…è”å¼•ç”¨**
   - åœ¨æ­£æ–‡ä¸­æ·»åŠ ä¸Šæ ‡å¼•ç”¨æ ‡è®° `[1]`
   - é“¾æ¥åˆ°å¯¹åº”çš„å¼•ç”¨æ¡ç›®

2. **å¼•ç”¨åˆ†ç±»**
   - æŒ‰æ¥æºç±»å‹åˆ†ç±»ï¼ˆæ–°é—»ã€è´¢æŠ¥ã€åˆ†ææŠ¥å‘Šï¼‰
   - æŒ‰ä¼˜å…ˆçº§æ’åº

3. **å¼•ç”¨å…ƒæ•°æ®**
   - æ·»åŠ è®¿é—®æ—¥æœŸ
   - æ·»åŠ ä½œè€…ä¿¡æ¯
   - æ·»åŠ å‘å¸ƒæ—¥æœŸ

4. **å¯¼å‡ºæ ¼å¼**
   - æ”¯æŒBibTeXæ ¼å¼
   - æ”¯æŒAPA/MLAæ ¼å¼
   - æ”¯æŒEndNoteæ ¼å¼

---

## âœ… å®ŒæˆçŠ¶æ€

- âœ… Sonar APIæå–citations
- âœ… ä¿¡æ¯æ”¶é›†ä¿å­˜citations
- âœ… ä¸»ç¨‹åºæ”¶é›†å’Œå»é‡
- âœ… æ ¼å¼åŒ–å™¨ç”Ÿæˆå¼•ç”¨éƒ¨åˆ†
- âœ… è‡ªåŠ¨åŸŸåè§£æ
- âœ… ä¸“ä¸šæ ¼å¼æ’ç‰ˆ
- âœ… å¼•ç”¨è®¡æ•°ç»Ÿè®¡

---

## ğŸ‰ ç°åœ¨å°±è¯•è¯•ï¼

```bash
# ç”Ÿæˆä¸€ä»½æ–°æŠ¥å‘Š
python main.py

# æŸ¥çœ‹æŠ¥å‘Šæœ«å°¾çš„"ğŸ“š References and Citations"éƒ¨åˆ†
# æ‰€æœ‰å¼•ç”¨æ¥æºéƒ½æ¸…æ™°å¯è§ï¼
```

**å¼•ç”¨æ¥æºç°åœ¨å®Œå…¨é€æ˜ã€å¯è¿½æº¯ï¼** ğŸ“šâœ¨

---

**ä¼˜åŒ–å®Œæˆæ—¶é—´**: 2024-11-07  
**å½±å“èŒƒå›´**: æ‰€æœ‰æ–°ç”Ÿæˆçš„æŠ¥å‘Š  
**å‘åå…¼å®¹**: æ˜¯ï¼ˆæ²¡æœ‰citationsæ—¶ä¸æ˜¾ç¤ºè¯¥éƒ¨åˆ†ï¼‰

