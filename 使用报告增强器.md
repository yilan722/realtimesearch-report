# 报告增强器使用指南

## 功能介绍

报告增强器（Report Enhancer）是一个强大的工具，可以：

✅ **修复表格格式** - 自动识别并重建损坏的markdown表格
✅ **生成数据可视化** - 从表格数据自动生成专业图表
✅ **清理HTML编码** - 移除 `&lt;`、`&gt;` 等HTML实体
✅ **优化表格样式** - 确保表格对齐美观

## 快速开始

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 增强单个报告

```bash
python report_enhancer.py reports/你的报告.md
```

输出将保存为 `reports/你的报告_enhanced.md`

### 3. 批量增强所有报告

```bash
python enhance_all_reports.py
```

## 使用示例

### 示例 1: 增强NVIDIA报告

```bash
cd /Users/yilanliu/Desktop/realtimesearch-report
python report_enhancer.py reports/nvda_20251104_161318.md
```

**处理效果：**

#### 原始报告（损坏的表格）：
```
MetricQ2 FY2026Q1 FY2026YoY ChangeRevenue$46.7B$44.1B+56%Net Income$26.4B$18.8BNot disclosed
```

#### 增强后（正确的表格 + 图表）：
```markdown
| Metric | Q2 FY2026 | Q1 FY2026 | YoY Change |
| --- | --- | --- | --- |
| Revenue | $46.7B | $44.1B | +56% |
| Net Income | $26.4B | $18.8B | Not disclosed |
| Gross Margin | 72.7% | Not disclosed | Stable |

**图表 1**: 数据可视化

![图表 1](charts/nvda_20251104_161318_chart_0.png)
```

### 示例 2: 在Python代码中使用

```python
from report_enhancer import ReportEnhancer

# 创建增强器实例
enhancer = ReportEnhancer()

# 增强报告
enhanced_path = enhancer.enhance_report("reports/my_report.md")
print(f"增强后的报告: {enhanced_path}")
```

## 支持的表格类型

增强器能够智能识别和重建以下类型的表格：

### 1. 财务指标表格
- Revenue（营收）
- Net Income（净利润）
- Gross Margin（毛利率）
- Operating Margin（营业利润率）
- EBITDA、EPS等

### 2. 估值比率表格
- P/E (TTM)
- P/S (TTM)
- P/B
- EV/EBITDA
- Forward P/E

### 3. 市场份额表格
- 业务板块
- 市场份额
- 关键产品

### 4. 技术路线图表格
- 年份
- 架构
- 关键特性

## 图表生成

增强器会自动：
1. 提取表格中的数值数据
2. 生成专业的柱状图
3. 保存到 `reports/charts/` 目录
4. 在报告中插入图表引用

**图表特性：**
- 支持多组数据对比
- 自动处理单位（B, M, K, %）
- 专业的样式和配色
- 高分辨率（150 DPI）

## 目录结构

```
realtimesearch-report/
├── report_enhancer.py          # 核心增强器
├── enhance_all_reports.py      # 批量处理脚本
├── reports/                    # 报告目录
│   ├── my_report.md           # 原始报告
│   ├── my_report_enhanced.md  # 增强后的报告
│   └── charts/                # 图表目录
│       └── my_report_chart_0.png
└── 使用报告增强器.md          # 本文件
```

## 配置选项

可以通过修改 `ReportEnhancer` 类来自定义：

```python
# 修改图表样式
plt.rcParams['font.size'] = 12
plt.rcParams['figure.figsize'] = (10, 6)

# 修改图表分辨率
plt.savefig(chart_path, dpi=150)  # 调整DPI
```

## 故障排除

### 问题1: 表格没有被识别

**原因**: 表格格式太特殊或包含太多普通文本

**解决**: 
- 检查原始表格是否包含明显的数据模式（数字、金额、百分比）
- 如果需要，可以在 `_is_broken_table_line()` 中添加新的识别模式

### 问题2: 图表生成失败

**原因**: 表格数据无法转换为数字

**解决**:
- 检查表格数据是否包含有效的数值
- 查看错误信息，确认是哪个单元格导致问题
- 确保数据格式一致（如都是$XX.XB或XX%）

### 问题3: 中文显示为方框

**原因**: 系统缺少中文字体

**解决**:
```python
# 在report_enhancer.py中设置字体
plt.rcParams['font.sans-serif'] = ['Arial Unicode MS', 'SimHei']
```

## 最佳实践

### 1. 先测试单个报告
```bash
# 先在一个报告上测试
python report_enhancer.py reports/test_report.md
# 检查结果，然后批量处理
python enhance_all_reports.py
```

### 2. 保留原始报告
增强器会创建新文件（_enhanced.md），不会覆盖原始报告

### 3. 定期清理charts目录
```bash
# 删除旧图表
rm reports/charts/*.png
```

### 4. 版本控制
```bash
# 将增强后的报告加入git
git add reports/*_enhanced.md reports/charts/*.png
git commit -m "Add enhanced reports with visualizations"
```

## 集成到主系统

可以在 `main.py` 中自动调用增强器：

```python
# 在生成报告后自动增强
result = system.generate_report(company="Apple", save_to_file=True)
if result["status"] == "success":
    from report_enhancer import ReportEnhancer
    enhancer = ReportEnhancer()
    enhanced_path = enhancer.enhance_report(result["metadata"]["saved_file"])
    print(f"增强报告: {enhanced_path}")
```

## 技术细节

### 表格识别算法
1. 逐行扫描，检测损坏表格特征
2. 收集连续的损坏行
3. 识别表格类型（财务/估值/市场份额等）
4. 使用特定的正则表达式解析
5. 重建为标准markdown表格

### 数值提取
1. 移除货币符号（$）、单位（B/M/K）、百分号（%）
2. 提取纯数字
3. 根据单位调整数值（B×1000, K÷1000）
4. 转换为float用于绘图

### 图表生成
1. 解析表格为数据结构
2. 识别标签列和数值列
3. 使用matplotlib生成柱状图
4. 保存为PNG
5. 在markdown中插入图片引用

## 更新日志

### v1.0.0 (2025-11-04)
- ✅ 初始版本发布
- ✅ 支持财务指标表格重建
- ✅ 支持估值比率表格重建
- ✅ 支持市场份额表格重建
- ✅ 自动生成数据可视化图表
- ✅ HTML实体清理
- ✅ 表格样式优化

## 反馈与支持

如有问题或建议，请：
1. 查看本文档的"故障排除"部分
2. 检查 `reports/charts/` 目录是否存在
3. 查看命令行输出的详细错误信息

---

**提示**: 增强器会自动跳过已经格式正确的表格，所以可以安全地对同一个报告多次运行！

